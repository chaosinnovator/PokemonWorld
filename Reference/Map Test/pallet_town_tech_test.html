<!doctype HTML>
<html>
	<head>
		<title>Pokemon World Technical Test</title>
		<script src="http://code.jquery.com/jquery-3.4.1.min.js"></script>
	</head>
	<body>
		<canvas id="gameCanvas" width="900" height="600" style="border: 1px solid black;"></canvas>
		<div>
			<p>
				Frame:&nbsp;<span id="frame_count">-</span><br />
				Target framerate:&nbsp;<span id="desired_framerate">-</span><br />
				Actual framerate:&nbsp;<span id="framerate">-</span><br />
			    Game state:&nbsp;<span id="game_state">-</span>
			</p>
			
			<p>
				Hero position:&nbsp;<span id="hero_pos">-</span><br />
				Camera position:&nbsp;<span id="cam_pos">-</span><br />
			    Tile size:&nbsp;<span id="tile_size">-</span>&nbsp;
				<button onclick="tile_width++">Bigger</button>&nbsp;
				<button onclick="tile_width--">Smaller</button><br />
			    Resource pack:&nbsp;<span id="selected_pack">-</span>
			</p>
			
			<p>
				Tile animation count:&nbsp;<span id="num_anims">-</span>&nbsp;
				(triggered: <span id="num_triggered_anims">-</span>)<br />
				Entity count:&nbsp;<span id="num_entities">-</span>
			</p>
		</div>
		<script>

class PokemonWorldGame {
	canvas = null;
	context = null;
	state = "starting";
// states:
//  starting - initial state
//  loading - loading resources
//  loaded - resources loaded but not playing yet
//  intro - playing game intro/splash screen(s)
//  main_menu - at game menu
//  playing - playing the game
// future:
//  auth_waiting - game waiting for user to sign in to an account
	resourceManager;
	frame_count = 0;
	last_frame_count = 0;
	desired_framerate = 50;
	gameLoopInterval;
	loop_running = false;
	
	start() {
		this.state = "loading";
		
		this.canvas = document.getElementById("gameCanvas");
		this.context = this.canvas.getContext("2d");
		this.context.imageSmoothingEnabled = false;
		
		this.resourceManager = new ResourceManager();
		
		// get resources
		this.resourceManager.loadResources();
		
		// loop
		var self = this;
		this.gameLoopInterval = setInterval(function() {self.update.bind(self)();}, 1000/this.desired_framerate);
	}
	
	update() {
		if (this.loop_running) {
			console.warn("Too slow! Skipping frame.");
			return;
		}
		this.loop_running = true;
		
		this.clear();
		
		updateDebug();
		
		if (this.state == "starting" || this.state == "loading") {
			this.context.font = "30px Arial";
			this.context.fillText("Loading... " + this.resourceManager.resources_loaded + "/" + this.resourceManager.resources_to_load, 30, 30);
			if (this.resourceManager.resources_loaded >= this.resourceManager.resources_to_load) {
				tempLoadSections();
			}
			this.loop_running = false;
			return;
		}
		
		showMap();
		
		this.frame_count++
		this.loop_running = false;
	}
	
	clear() {
		this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
	}
}

class ResourceManager {
	resources_to_load = 0;
	resources_loaded = 0;
	resource_pack_assets = {};
	resource_pack_manifest = {};
	selected_resource_pack = "default";
	resource_pack_manifest;
	
	loadResources() {
		var self = this;
		//$.getJSON("resource packs/" + selected_resource_pack + "/manifest.json");
		$.getJSON("https://api.myjson.com/bins/ir4ka", function(data) {
			//resource_pack_manifest = data;
			self.resource_pack_manifest = temp_manifest;
			console.log();
			self.loadResourcesFromManifest();
		});
	}
	
	loadResourcesFromManifest() {
		var tileId;
		var tileData;
		this.resources_to_load = Object.keys(this.resource_pack_manifest.tile_textures).length;
		this.resources_loaded = 0;
		this.resource_pack_assets = {};
		this.resource_pack_assets.tile_textures = {};
		for (tileId in this.resource_pack_manifest.tile_textures) {
			tileData = this.resource_pack_manifest.tile_textures[tileId];
			if (tileData !== null && typeof tileData === "object") {
				// more complex tile loading
				switch (tileData.type) {
					case "static":
						this.loadTileTextures(tileId, tileData.src);
						break;
					case "animated":
						// now we have a multiple tile textures to load
						this.resources_to_load += (tileData.src.length-1);
						this.loadTileTextures(tileId, tileData.src);
						break;
					default:
						console.warn("Resource pack '" + this.selected_resource_pack + "': tile '" + tileId + "' doesn't have a valid texture.");
						this.loadTileTextures(tileId, ["placeholder.png"]);
				}
				continue;
			}
			if (typeof tileData !== "string") {
				// error in pack manifest, also covers null
				console.warn("Resource pack '" + this.selected_resource_pack + "': tile '" + tileId + "' doesn't have a valid texture.");
				// make a placeholder tile image with tileId text on it
				this.loadTileTextures(tileId, ["placeholder.png"]);
				continue;
			}
			// should just be a string representing the texture's src now, shorthand for above 'static' type
			this.loadTileTextures(tileId,[tileData]);
		}
	}
	
	loadTileTextures(tileId, srcs) {
		var src, img;
		this.resource_pack_assets.tile_textures[tileId] = [];
		var self = this;
		for (src of srcs) {
			img = new Image();
			img.onload = function() {
				self.resources_loaded++;
			}
			img.onerror = function() {
				console.warn("Resource pack '" + self.selected_resource_pack + "': tile '" + tileId + "' couldn't load texture from " + src + ".");
				// make a placeholder tile image with tileId text on it
				self.src = "resource packs/default/placeholder.png";
			}
			img.src = "resource packs/" + this.selected_resource_pack + "/" + src;
			this.resource_pack_assets.tile_textures[tileId].push(img);
		}
	}
}

var our_player_id = "testid";
var tile_width = 32;
var camX = 8;
var camY = 8;
var map_sections;
var frCheckInterval;
var loop_running = false;
var framerate = 0;
var num_animations = 0;
var num_triggered_animations = 0;
var num_entities = 0;
var animations = {};
var entities = {};

function tempLoadSections() {
	map_sections = {};
	// get map section 0,0
	$.getJSON("https://api.myjson.com/bins/1bc636", parseMapSection);
}

function parseMapSection(data) {
	map_sections[0] = {};
	map_sections[0][0] = data;
	console.log("Map section 0,0 loaded.");
	pokemonWorldGame.state="loaded";
}

function frCheck() {
	pokemonWorldGame.framerate = pokemonWorldGame.frame_count-pokemonWorldGame.last_frame_count;
	pokemonWorldGame.last_frame_count = pokemonWorldGame.frame_count;
	if (pokemonWorldGame.desired_framerate < 500 && pokemonWorldGame.framerate < pokemonWorldGame.desired_framerate) {
		console.warn("Low framerate: " + pokemonWorldGame.framerate);
	}
}

function updateDebug() {
	var secX, secY;
	
	$("#frame_count").text(pokemonWorldGame.frame_count);
	$("#desired_framerate").text(pokemonWorldGame.desired_framerate);
	$("#framerate").text(pokemonWorldGame.framerate);
	$("#game_state").text(pokemonWorldGame.state);
	
	secX = Math.floor(camX/16);
	secY = Math.floor(camY/16);
	
	$("#cam_pos").text("x: "+camX+" x: "+camY+" sx: "+secX+" sy: "+secY);
	$("#tile_size").text(tile_width);
	$("#selected_pack").text(pokemonWorldGame.selected_resource_pack);
	
	$("#num_anims").text(num_animations);
	$("#num_triggered_anims").text(num_triggered_animations);
	$("#num_entities").text(num_entities);
}

function showMap() {
	var left = (pokemonWorldGame.canvas.width/2)-(camX*tile_width)-(tile_width/2);
	var top = (pokemonWorldGame.canvas.height/2)-(camY*tile_width)-(tile_width/2);
	//for each section {
		num_layers = map_sections[0][0].tile_layers.length;
		entity_layer = map_sections[0][0].entity_layer;
		for (layer=0;layer<num_layers;layer++) {
			for (x=0;x<16;x++) {
				for (y=0;y<16;y++) {
					palletId = map_sections[0][0].tile_layers[layer][y][x];
					tileId = map_sections[0][0].tile_pallet[palletId];
					frame = getAnimationFrameOrDefault(0, 0, x, y, layer, tileId);
					pokemonWorldGame.context.drawImage(pokemonWorldGame.resourceManager.resource_pack_assets.tile_textures[tileId][frame], left+(x*tile_width), top+(y*tile_width), tile_width, tile_width);
				}
			}
			if (layer === entity_layer) {
				// draw entities
				// draw player(s)
			}
		}
	// }
}


function getAnimationFrameOrDefault(sx, sy, x, y, layer, tileId) {
	if (pokemonWorldGame.resourceManager.resource_pack_manifest.tile_textures[tileId].type != "animated") {
		return 0;
	}
	
	animKey = "" + sx + "-" + sy + "-" + x + "-" + y + "-" + layer;
	
	if (!(animKey in animations)) {
		animations[animKey] = {
			trigger: pokemonWorldGame.resourceManager.resource_pack_manifest.tile_textures[tileId].trigger,
			frame_time: pokemonWorldGame.resourceManager.resource_pack_manifest.tile_textures[tileId].frame_time,
			repeat: pokemonWorldGame.resourceManager.resource_pack_manifest.tile_textures[tileId].repeat,
			numFrames: pokemonWorldGame.resourceManager.resource_pack_manifest.tile_textures[tileId].src.length,
			currentFrame: 0,
			currentFrameCounter: 0,
			plays: 0,
			triggered: false,
			triggered_by: null
		}
		num_animations++;
	}
	
	if (!animations[animKey].triggered && animations[animKey].trigger == "load") {
		animations[animKey].triggered = true;
		num_triggered_animations++;
	}
	
	if (animations[animKey].triggered) {
		animations[animKey].currentFrameCounter++;
		if (animations[animKey].currentFrameCounter > animations[animKey].frame_time) {
			animations[animKey].currentFrame++;
			animations[animKey].currentFrameCounter = 0;
		}
	}
	
	if (animations[animKey].currentFrame >= animations[animKey].numFrames) {
		animations[animKey].currentFrame%=animations[animKey].numFrames;
		if (animations[animKey].repeat != 0) {
			if (animations[animKey].plays++ >= animations[animKey].repeat) {
				animations[animKey].triggered = false;
				num_triggered_animations--;
			}
		}
	}
	
	return animations[animKey].currentFrame;
}

var pokemonWorldGame;

$(document).ready(function() {
	pokemonWorldGame = new PokemonWorldGame();
	pokemonWorldGame.start();
	frCheckInterval = setInterval(frCheck, 1000);
});


temp_manifest = {
	"tile_textures": {
		"gen3:void": {
			"type": "static",
			"src": [
				"gen3/void.png"
			]
		},
		"gen3:tree_md_bottomleft": "gen3/tree_md_bottomleft.png",
		"gen3:tree_md_bottomright": "gen3/tree_md_bottomright.png",
		"gen3:grass1_variant1": "gen3/grass1_variant1.png",
		"gen3:grass1_variant2": "gen3/grass1_variant2.png",
		"gen3:tree_md_midleft_nobg": "gen3/tree_md_midleft_nobg.png",
		"gen3:tree_md_midright_nobg": "gen3/tree_md_midright_nobg.png",
		"gen3:tree_md_topleft_nobg": "gen3/tree_md_topleft_nobg.png",
		"gen3:tree_md_topright_nobg": "gen3/tree_md_topright_nobg.png",
		"gen3:path1_outsidecorner_topleft_thick": "gen3/path/path1_outsidecorner_topleft_thick.png",
		"gen3:path1_outsidecorner_topright_thick": "gen3/path/path1_outsidecorner_topright_thick.png",
		"gen3:path1_side_left_thick": "gen3/path/path1_side_left_thick.png",
		"gen3:path1_center": "gen3/path/path1_center.png",
		"gen3:path1_side_right_thick": "gen3/path/path1_side_right_thick.png",
		"gen3:path1_side_top_thick": "gen3/path/path1_side_top_thick.png",
		"gen3:path1_insidecorner_topleft_thick_variant1": "gen3/path/path1_insidecorner_topleft_thick_variant1.png",
		"gen3:path1_insidecorner_topright_thick": "gen3/path/path1_insidecorner_topright_thick.png",
		"gen3:path1_insidecorner_bottomright_thin": "gen3/path/path1_insidecorner_bottomright_thin.png",
		"gen3:path1_insidecorner_bottomleft_thin": "gen3/path/path1_insidecorner_bottomleft_thin.png",
		"gen3:path1_side_bottom_thin": "gen3/path/path1_side_bottom_thin_variant1.png",
		"gen3:path1_side_right_thin": "gen3/path/path1_side_right_thin.png",
		"gen3:path1_insidecorner_topright_thickthin": "gen3/path/path1_insidecorner_topright_thickthin.png",
		"gen3:path1_insidecorner_topleft_thickthin": "gen3/path/path1_insidecorner_topleft_thickthin.png",
		"gen3:path1_side_left_thin": "gen3/path/path1_side_left_thin.png",
		"gen3:grass1_variant5": "gen3/grass1_variant5.png",
		"gen3:path1_side_bottom_thin_variant2": "gen3/path/path1_side_bottom_thin_variant2.png",
		"gen3:grass1_variant3": "gen3/grass1_variant3.png",
		"gen3:grass1_variant4": "gen3/grass1_variant4.png",
		"gen3:fence1_horizontal": "gen3/fence1_horizontal.png",
		"gen3:sign1": "gen3/sign1.png",
		"gen3:sign2": "gen3/sign2.png",
		"gen3:flower1": {
			"type": "animated",
			"src": [
				"gen3/flower1_frame1.png",
				"gen3/flower1_frame2.png",
				"gen3/flower1_frame3.png",
				"gen3/flower1_frame4.png",
				"gen3/flower1_frame5.png"
			],
			"trigger": "load",
			"frame_time": 16,
			"repeat": 0
		},
		"gen3:tallgrass1_base": "gen3/tallgrass1_base.png",
		"gen3:tallgrass1_top": {
			"type": "animated",
			"src": [
				"gen3/tallgrass1_top_frame1.png",
				"gen3/tallgrass1_top_frame2.png",
				"gen3/tallgrass1_top_frame3.png",
				"gen3/tallgrass1_top_frame4.png"
			],
			"trigger": "entity_enter",
			"frame_time": 5,
			"repeat": 1
		},
		"gen3:mailbox1_part1": "gen3/mailbox1_part1.png",
		"gen3:mailbox1_part2": "gen3/mailbox1_part2.png",
		"gen3:house1_roof_red_n": "gen3/buildings/house1_roof_red_n.png",
		"gen3:house1_roof_red_nw": "gen3/buildings/house1_roof_red_nw.png",
		"gen3:house1_roof_red_ne": "gen3/buildings/house1_roof_red_ne.png",
		"gen3:house1_roof_red_w": "gen3/buildings/house1_roof_red_w.png",
		"gen3:house1_roof_red": "gen3/buildings/house1_roof_red.png",
		"gen3:house1_roof_red_e": "gen3/buildings/house1_roof_red_e.png",
		"gen3:house1_roof_red_sw": "gen3/buildings/house1_roof_red_sw.png",
		"gen3:house1_roof_red_s": "gen3/buildings/house1_roof_red_s.png",
		"gen3:house1_roof_red_se": "gen3/buildings/house1_roof_red_se.png",
		"gen3:house1_wall_w2": "gen3/buildings/house1_wall_w2.png",
		"gen3:house1_wall_w1": "gen3/buildings/house1_wall_w1.png",
		"gen3:house1_wall_2_part1": "gen3/buildings/house1_wall_2_part1.png",
		"gen3:house1_wall_2_part2": "gen3/buildings/house1_wall_2_part2.png",
		"gen3:house1_wall_2_part3": "gen3/buildings/house1_wall_2_part3.png",
		"gen3:house1_wall_e2": "gen3/buildings/house1_wall_e2.png",
		"gen3:house1_wall_e1": "gen3/buildings/house1_wall_e1.png",
		"gen3:house1_wall_1_part2": "gen3/buildings/house1_wall_1_part2.png",
		"gen3:house1_wall_1_part1": "gen3/buildings/house1_wall_1_part1.png",
		"gen3:house1_door1_red": "gen3/buildings/house1_door1_red.png"
	},
	"entity_textures": {},
	"sounds": {}
};
		</script>
	</body>
</html>